# ДЗ - 2 СУБД АДминистрирование


## Работа с БД через сервисную учетную запись

Для начала разберем имеющиеся схемы в таблиц и количество обновлений

---

### Таблица `subscription_types`

Таблица `subscription_types` хранит данные о различных типах подписок, которые доступны пользователям.

Нету необходимости изменять эту таблицу, так как все виды подписок задаются заранее и должны изменяться только superuserом, обычный пользователь может лишь посмотреть виды подписок и их условия

**Установленные разрешения**
- SELECT

---


### Таблица `complaint_types`

Таблица `complaint_types` хранит типы жалоб, которые могут быть поданы пользователями.

Нету необходимости изменять эту таблицу, так как все виды жалоб задаются заранее для удобства администрирования и должны изменяться только superuserом, обычный пользователь может лишь получить их типы для заполнения формы 

**Установленные разрешения**
- SELECT

---



### Таблица `notification_types`

Таблица `notification_types` хранит типы уведомлений, которые получают пользователи.

Нету необходимости изменять эту таблицу, так как все виды уведомлений задаются заранее для удобства администрирования и должны изменяться только superuserом, обычный пользователь может лишь получить их типы для выдачи уведомлений

**Установленные разрешения**
- SELECT

---



### Таблица `queries`

Таблица `queries` хранит опросы, которые получают пользователи.

Нету необходимости изменять эту таблицу, так как все виды опросов задаются заранее для удобства администрирования и должны изменяться только superuserом, обычный пользователь может лишь получить их для прохождения

**Установленные разрешения**
- SELECT

---


### Таблица `admins`

Таблица `admins` хранит аккаунты админов

Нету необходимости изменять эту таблицу, так как все админы задаются и назначаются superuserом, обычный пользователь не имеет права доступа к ним

**Установленные разрешения**
- SELECT

---


### Остальные таблицы

#### Таблица `static`
Таблица `static` хранит информацию о статичных данных, таких как изображения или другие файлы, загружаемые пользователями или системой.

---

#### Таблица `sessions`
Таблица `sessions` хранит данные о сессиях пользователей. Каждая запись представляет собой активную сессию пользователя с уникальным токеном для аутентификации.

---

#### Таблица `users`
Таблица `users` хранит информацию о пользователях системы, включая их личные данные и учетные записи.

---

#### Таблица `user_answer`
Таблица `user_answer` хранит информацию об ответах пользователей на опросы

---

#### Таблица `profiles`

Таблица `profiles` содержит информацию о профилях пользователей, таких как их имя, дата рождения, местоположение и описание.

---

#### Таблица `interests`

Таблица `interests` хранит интересы, которые могут быть связаны с профилями пользователей.


---

#### Таблица `profile_interests`

Таблица `profile_interests` служит для связи профилей с их интересами, реализуя связь многие ко многим между таблицами `profiles` и `interests`.


---

#### Таблица `profile_ratings`

Таблица `profile_ratings` служит для хранения отзывов на конкретный профиль с рейтингом и тестовыми пояснениями

---


#### Таблица `notifications`

Таблица `notifications` служит для хранения уведомлений, которые требуется отдать пользователям

---

#### Таблица `preferences`

Таблица `preferences` хранит данные о предпочтениях пользователей, такие как предпочтения по возрасту, городу и другим факторам.

---

#### Таблица `profile_preferences`

Таблица `profile_preferences` служит для связи профилей с их предпочтениями, реализуя связь многие ко многим между таблицами `profiles` и `preferences`.

---

#### Таблица `locations`

Таблица `locations` хранит данные о местоположениях, которые могут быть связаны с профилями пользователей.

---

#### Таблица `messages`

Таблица `messages` хранит данные о сообщениях, отправленных между профилями пользователей.

---

#### Таблица `likes`

Таблица `likes` хранит данные о том, какие профили нравятся другим профилям. Это используется для моделирования лайков между пользователями.


---

#### Таблица `matches`

Таблица `matches` хранит данные о совпадениях между профилями. Совпадение происходит, когда два профиля выразили интерес друг к другу (например, лайкнули друг друга).

---

#### Таблица `chats`

Таблица `chats` хранит данные о чатах, которые созданы пользователями

---

#### Таблица `subscriptions`

Таблица `subscriptions` хранит данные о подписках пользователей на различные типы сервисов.

---

#### Таблица `complaints`

Таблица `complaints` хранит данные о жалобах пользователей на другие профили или на систему в целом.


---

#### Таблица `blacklist`

Таблица `blacklist` хранит данные о пользователях, заблокированных на платформе.

К остальным таблицам приложению необходим доступ не только на чтение, но и на запись, редактирование и  удаление

**Установленные разрешения**
- SELECT
- INSERT
- UPDATE
- DELETE


Код подключения хранится в папке repository/db/03_permissions

Этот код выполняется сразу после инициализации 

## Защита от SQL Injections

Для подключения к SQL используется библиотека pgx и "database/sql", все запросы пишутся явно
Подключение идет через *sql.DB

Для экранирования в запросах используются позиционные параметры в SQL-запросе.

Они используются вместо прямой подстановки значений в SQL-строку, чтобы:

- Защититься от SQL-инъекций.
- Упростить работу с типами данных.
- Повысить читаемость и повторное использование SQL-запросов.

Например в запросе на добавление сообщения
```sql
INSERT INTO chats (first_profile_id, second_profile_id, last_message, last_sender)
		VALUES ($1, $2, $3, $4)
		ON CONFLICT (first_profile_id, second_profile_id) DO NOTHING
		RETURNING chat_id;
```


### Организация тестирования

Для тестирования используется утилита sqlmap. Сценерий тестирования выглядит так

```sh
LOGIN_USER_URL="http://localhost:8080/users/login"
sqlmap -u "$LOGIN_USER_URL" --method POST \
  --data='{"login": "testuser", "password": "password123"}' \
  --headers="Content-Type: application/json" \
  --cookie="$COOKIE" \
  --risk=3 --level=5 --batch --ignore-code="500,400,403"

```

- LOGIN_USER_URL UQL тестирования запроса
- --data= передаваемые в post запросе параметры
-  --cookie= - куки для подключения
- --ignore-code= - коды, которые игнорируют ошибки с HTTP-статусом, это означает что данные или неверны по формату или пользователь не авторизован

#### Запись тестирования на инъекции с помощью sqlmap

```
https://asciinema.org/a/C4JcIX2bLKKoXhG62qMMA06A7
```

## Пул соединений и параметры соединений

## Настройка параметров сервера и клиента

